# 策略算法与交易逻辑详细说明

本文档详细描述了系统中使用的多空判断、价格点位计算及风险控制逻辑。

## 1. 核心趋势判断 (Trend Logic)

系统采用 **双均线 (Dual EMA)** 结合 **价格位置** 进行趋势识别。

### 基础算法 (compute_signal)
对任意给定的 K 线周期，计算逻辑如下：

1.  **计算指标**：
    *   **快线 (Fast EMA)**: 收盘价的 $N_{fast}$ 周期指数移动平均（默认 20）。
    *   **慢线 (Slow EMA)**: 收盘价的 $N_{slow}$ 周期指数移动平均（默认 60）。
    *   **当前收盘价 (Last Close)**: 最新一根 K 线的收盘价。

2.  **方向判定规则**：
    *   **🟢 做多 (Long)**：
        *   `快线 > 慢线` （均线金叉/多头排列）
        *   **且** `收盘价 > 慢线` （价格位于长期均线上方）
    *   **🔴 做空 (Short)**：
        *   `快线 < 慢线` （均线死叉/空头排列）
        *   **且** `收盘价 < 慢线` （价格位于长期均线下方）
    *   **⚪ 观望 (Hold)**：
        *   不满足上述任一条件（例如：均线多头但价格跌破慢线，或均线纠缠中）。

### 双周期共振 (Dual Period Resonance)
系统支持主周期（Primary）与辅助周期（Secondary）联合判断（需配置 `--period-2`）：

1.  分别计算主周期和辅助周期的方向。
2.  **共振规则**：
    *   若 `主周期方向 == 辅助周期方向`：确认趋势有效。
    *   若 `方向不一致`：强制 **观望**。
3.  **执行依据**：
    *   共振成功时，最终的交易点位（入场、止损、止盈）采用 **第二周期 (Secondary)** 的计算结果。
    *   *注：这通常意味着如果配置了大小周期，应确保第二周期的参数适合作为入场依据。*

---

## 2. 价格点位算法 (Price Levels)

所有价格点位均基于信号触发时的最新 K 线数据计算。

### 2.1 入场价格 (Entry Price)
*   **算法**：直接取信号触发时的 **最新收盘价 (Last Close)**。
*   *注意：实盘中可能存在滑点，此处为理论信号价格。*

### 2.2 止损价格 (Stop Price)
基于 **ATR (平均真实波幅)** 的动态止损，适应市场波动率。

*   **指标**：$ATR(N)$，默认 $N=14$。
*   **公式**：
    *   **做多止损** = `入场价 - (当前ATR × StopMultiplier)`
    *   **做空止损** = `入场价 + (当前ATR × StopMultiplier)`
*   **默认参数**：`StopMultiplier` (stop-mult) 默认为 2.0。

### 2.3 止盈价格 (Take Profit Price)
基于风险回报比（盈亏比）计算。

*   **基础风险距离 (Stop Distance)** = `| 入场价 - 止损价 |`
*   **公式**：
    *   **做多止盈** = `入场价 + (风险距离 × TPMultiplier)`
    *   **做空止盈** = `入场价 - (风险距离 × TPMultiplier)`
*   **默认参数**：`TPMultiplier` (tp-mult) 默认为 2.0（即目标盈亏比 2:1）。

### 2.4 支撑与压力 (Support & Resistance)
基于近期价格极值计算，用于参考。

*   **回溯范围**：过去 $N_{sr}$ 根 K 线（默认 sr-lookback=20）。
*   **公式**：
    *   **支撑位** = 最近 N 根 K 线的 **最低价 (Lowest Low)**。
    *   **压力位** = 最近 N 根 K 线的 **最高价 (Highest High)**。

---

## 3. 仓位与风控 (Position & Risk)

系统根据账户权益和单笔风险上限自动计算建议手数。

1.  **单合约风险值** = `| 入场价 - 止损价 | × 合约乘数`
    *   *合约乘数 (Contract Multiplier)*：如螺纹钢为 10（10吨/手）。
2.  **总风险预算** = `账户总权益 (Equity) × 单笔风险比例 (RiskPct)`
    *   默认 `Equity`=50000, `RiskPct`=0.02 (2%)。
3.  **建议手数** = `向下取整(总风险预算 / 单合约风险值)`
    *   若算出的手数 < 1，则建议手数为 0（风险不足以开一手）。

---

## 4. 逻辑依据说明 (Reason Logic)

系统在输出信号时会附带“依据”字段，格式如下：

*   **单周期模式**：
    *   格式：`EMA{快线周期}/{慢线周期}`
    *   示例：`EMA20/60` —— 表示基于 EMA20 和 EMA60 的交叉判断。
*   **双周期模式**：
    *   格式：`{主周期依据}+{辅助周期依据}`
    *   示例：`EMA20/60+EMA10/30` —— 表示主周期满足 EMA20/60 条件，且辅助周期满足 EMA10/30 条件，两者方向一致。
*   **特殊状态**：
    *   `无趋势`：价格在均线之间或不满足多空条件。
    *   `方向不一致`：双周期方向冲突。
    *   `冷却中...`：信号方向未变且未通过冷却期（Runner 层逻辑）。

## 5. 示例计算

假设：
*   做多信号，收盘价 3500
*   ATR = 50
*   Stop Mult = 2.0, TP Mult = 2.0
*   合约乘数 = 10
*   权益 = 50000, 风险比 = 2% (1000元)

**计算结果**：
1.  **入场**：3500
2.  **止损**：$3500 - (50 \times 2.0) = 3400$
3.  **止盈**：风险距离 $3500-3400=100$，止盈 $3500 + (100 \times 2.0) = 3700$
4.  **单手风险**：$100 \times 10 = 1000$ 元
5.  **手数**：$1000 / 1000 = 1$ 手
