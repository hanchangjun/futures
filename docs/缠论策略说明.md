# 缠论策略说明 (Chan Strategy)

本文档详细描述了基于缠论 (Chan Theory) 的量化交易策略，包括信号生成、风险控制及多周期过滤逻辑。系统目前支持 **Rebar Strategy (螺纹钢专用策略)** 与 **Pure Chan Strategy (纯缠论策略)** 两种模式，其中 Rebar Strategy 支持高度参数化配置。

## 1. 核心概念

策略基于缠论的核心几何结构进行构建：

| 概念 | 定义 | 作用 |
| :--- | :--- | :--- |
| **分型 (Fractal)** | 顶分型与底分型 | K 线结构的极值点，构成笔的基础 |
| **笔 (Bi)** | 连接相邻的顶底分型 | 基础的价格波动段，构成中枢的元件 |
| **中枢 (Center)** | 由连续三笔重叠部分构成 | 定义价格震荡区间 (ZD, ZG)，判断趋势与盘整 |
| **背驰 (Divergence)** | 比较前后两笔的 MACD 力度 | 趋势衰竭的信号，用于捕捉第一类买卖点 |

## 2. 信号定义 (Signal Definitions)

策略识别以下三类买卖点：

### 2.1 信号类型对照表

| 信号类型 | 别名 | 核心逻辑 | 市场含义 |
| :--- | :--- | :--- | :--- |
| **1B** | 一买 | 趋势背驰 (Trend Divergence) | 下跌趋势衰竭，潜在的反转点 |
| **1S** | 一卖 | 趋势背驰 (Trend Divergence) | 上升趋势衰竭，潜在的见顶点 |
| **2B** | 二买 | 第一次回调不破前低 | 趋势反转后的确认，右侧入场点 |
| **2S** | 二卖 | 第一次反弹不破前高 | 顶部确认后的右侧做空点 |
| **3B** | 三买 | 突破中枢后的回踩不破 ZG | 上涨中继，趋势加速信号 |
| **3S** | 三卖 | 跌破中枢后的反抽不破 ZD | 下跌中继，趋势加速信号 |

### 2.2 详细判定规则

#### 第一类买卖点 (1B/1S)
> **逻辑**: 在趋势走势中（至少包含两个同向中枢），最后一段离开中枢的笔与前一段进入中枢的笔相比，出现 MACD 力度（面积或黄白线高度）衰竭。
*   **1B**: 创新低 + MACD 背驰。
*   **1S**: 创新高 + MACD 背驰。

#### 第二类买卖点 (2B/2S)
> **逻辑**: 发生在第一类买卖点之后，是对转折的确认。
*   **2B**: 一买后的第一笔向下回调，不跌破一买的最低点。
*   **2S**: 一卖后的第一笔向上反弹，不突破一卖的最高点。

#### 第三类买卖点 (3B/3S)
> **逻辑**: 发生在离开中枢之后，是对中枢破坏的确认。**严格要求离开笔与回撤笔紧邻 (Adjacent Bi)。**
*   **3B**: 向上离开中枢（Start $\le$ ZG），随后的紧邻回撤笔最低点 **> ZG**。
*   **3S**: 向下离开中枢（Start $\ge$ ZD），随后的紧邻反弹笔最高点 **< ZD**。

## 3. 风险管理与参数配置 (Risk Management & Configuration)

本系统采用 **参数化配置 (`params.json`)** 驱动风险管理模块，支持在 Web 界面动态调整。以下规则基于默认配置 (Rebar Strategy)，实际运行以 `params.json` 为准。

### 3.1 仓位管理 (Position Sizing)

| 信号类型 | 默认仓位 (Initial Pos) | 加仓/最大仓位 | 策略逻辑 |
| :--- | :---: | :---: | :--- |
| **1B / 1S** | **3%** (可配) | 目标 5% | **左侧交易**：逆势摸顶底，风险最高，轻仓试错。 |
| **2B / 2S** | **2%** (可配) | 最大 8% | **右侧交易**：趋势确认，但需防假突破。 |
| **3B / 3S** | **2%** (可配) | 禁止加仓 | **顺势交易**：趋势中后段，防止大幅回撤，严控仓位。 |

### 3.2 动态止损 (Dynamic Stop Loss)

止损位根据结构与 ATR (平均真实波幅) 动态生成：

*   **1B / 1S**: 结构极值点 $\pm$ `sl_multiplier` $\times$ ATR (默认 1.2 倍)
*   **2B / 2S**: 取 1B 极值与当前 2B 极值的较优者 (Min/Max)
*   **3B / 3S**: 中枢边界 (ZG/ZD) 与 回调笔极值的较宽者

### 3.3 特殊风控规则 (Rebar Specifics)

针对螺纹钢品种特性，集成了以下高级风控：

1.  **时间过滤器 (Time Filter)**:
    *   **交易时段**: 09:00-11:30, 13:30-15:00, 21:00-23:00 (夜盘)。
    *   **强制平仓窗口**: 09:00-09:30, 14:45-15:00 (特定策略要求)。

2.  **价格过滤器 (Price Filter)**:
    *   **整数关口**: 在 3600, 3700 等整数关口附近 (±10跳)，若波动率过低 (Range <= 5)，过滤信号。
    *   **涨跌停保护**: 涨跌幅超过 7% 停止开仓；超过 5% 自动减仓。

3.  **合约换月与基差 (Contract Switch)**:
    *   **深贴水 (Deep Discount)**: 基差 < -1.5% 时，做多信号权重增加 (+30%)。
    *   **高升水 (High Premium)**: 基差 > +1.5% 时，做空信号权重增加 (+30%)。

4.  **全局风控**:
    *   **最大单笔亏损**: 2% (账户权益)。
    *   **最大总回撤**: 5% (触发强平)。

## 4. 系统配置 (System Configuration)

所有策略参数均可通过 Web 界面的 **"Config"** 标签页进行实时查看与修改。

*   **配置文件**: `strategy/rebar/params.json`
*   **修改方式**: 在 Web 编辑器中修改 JSON 后点击 "Save"，系统下一次运行策略时自动生效。

### 配置示例 (params.json Fragment)
```json
"risk_control": {
    "signals": {
        "1B": {
            "sl_multiplier": 1.2,
            "initial_pos": 0.03
        }
    }
}
```

## 5. 数据源与回测 (Data & Backtest)

本系统支持灵活的数据源配置与两种回测模式，结果统一持久化至数据库。

### 5.1 回测模式
1.  **事件驱动回测 (Event-Driven)**:
    *   模拟真实交易流，集成 `Portfolio` 与 `RiskManager`。
    *   命令: `python main.py --event-backtest --symbol KQ.m@SHFE.rb --period 30m`
2.  **向量化回测 (Vectorized)**:
    *   基于 Pandas 高速计算，适合快速验证策略逻辑。
    *   通过 Web 界面 "Backtest" 标签页直接调用。

### 5.2 结果持久化
*   所有回测结果存储至本地数据库 (`BacktestResult` 表)。
*   通过 Web 界面直接查询历史回测记录。

## 6. 系统更新日志 (System Changelog)

### v2.1.0 (Latest)
*   **Web Config Editor**: 新增在线配置编辑器，支持直接修改 `params.json`。
*   **Docs Center**: 文档系统重构，统一至 `docs/` 目录。
*   **Rebar Strategy**: 完整的参数化策略实现，包含时间/价格过滤与基差权重。

### v2.0.x
*   **纯缠论策略 (Pure Chan)**: 完整实现 1B/2B/3B 信号逻辑与中枢识别。
*   **参数隔离**: 支持多品种差异化配置。
*   **回测数据库化**: 移除文件系统存储，回测结果全面迁移至数据库。
