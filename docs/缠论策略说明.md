# 缠论策略说明 (Chan Strategy)

本文档详细描述了基于缠论 (Chan Theory) 的量化交易策略，包括信号生成、风险控制及多周期过滤逻辑。

## 1. 核心概念

策略基于缠论的核心几何结构进行构建：
*   **分型 (Fractal)**: 顶分型与底分型，作为 K 线结构的极值点。
*   **笔 (Bi)**: 连接相邻的顶底分型，构成基础的价格波动段。
*   **中枢 (Center)**: 由连续三笔重叠部分构成，定义价格震荡区间 (ZD, ZG)。
*   **背驰 (Divergence)**: 比较前后两笔的 MACD 力度（面积/高度），判断趋势衰竭。

## 2. 信号定义

策略识别以下三类买卖点：

### 2.1 第一类买卖点 (1B/1S) - 趋势转折
*   **逻辑**: 趋势背驰 (Trend Divergence)。
*   **1B (一买)**: 下跌趋势中，当前向下笔的 MACD 力度弱于前一向下笔，且创出新低。
*   **1S (一卖)**: 上升趋势中，当前向上笔的 MACD 力度弱于前一向上笔，且创出新高。

### 2.2 第二类买卖点 (2B/2S) - 确认回调
*   **逻辑**: 第一次次级别回调不破前低/前高。
*   **2B (二买)**: 在一买 (或潜在底部) 后的向下回撤笔，其最低点高于前一低点。
*   **2S (二卖)**: 在一卖 (或潜在顶部) 后的向上回抽笔，其最高点低于前一高点。

### 2.3 第三类买卖点 (3B/3S) - 中枢破坏与确认
*   **逻辑**: 突破中枢后的回踩确认。
*   **3B (三买)**: 向上离开中枢的一笔，随后的回撤笔最低点 **不进入** 中枢高点 (ZG)。
*   **3S (三卖)**: 向下离开中枢的一笔，随后的反弹笔最高点 **不进入** 中枢低点 (ZD)。

## 3. 风险管理 (Risk Management)

### 3. 风险管理 (Risk Management) & 仓位管理 (Position Sizing)

本系统集成了针对期货交易（特别是螺纹钢）优化的风险控制与仓位管理模块。

#### 3.1 仓位管理 (Position Sizing)
基于信号类型与风险偏好，系统自动计算建议仓位：
*   **第一类买卖点 (1B/1S)**:
    *   **定义**: 趋势背驰/转折点。
    *   **仓位**: **10%** 基础仓位 (Max 20%)。
    *   **逻辑**: 逆势抄底/摸顶，风险较高，但盈亏比极佳，故轻仓尝试。
*   **第二类买卖点 (2B/2S)**:
    *   **定义**: 第一次回调确认。
    *   **仓位**: **7%** 基础仓位 (Max 15%)。
    *   **逻辑**: 趋势确认后的右侧入场，胜率较高。
*   **第三类买卖点 (3B/3S)**:
    *   **定义**: 中枢破坏后的趋势延续。
    *   **仓位**: **5%** 基础仓位 (Max 8%)。
    *   **逻辑**: 顺势加仓，处于趋势中后段，防止大幅回撤，严控仓位。

#### 3.2 动态止损 (Dynamic Stop Loss)
止损位根据缠论结构与市场波动率 (ATR) 动态生成：
*   **结构性止损**:
    *   **1B/1S**: 以前一笔的极值点（底分型最低点/顶分型最高点）为基准。
    *   **2B/2S**: 以回调笔的极值点为基准。
    *   **3B/3S**: 以回调笔极值点或中枢边界 (ZG/ZD) 为基准。
*   **波动率调节 (ATR Buffer)**:
    *   基础缓冲: `0.5 * ATR`。
    *   **夜盘风控 (Night Session)**: 针对螺纹钢夜盘 (21:00-02:30)，止损宽容度自动扩大 **30%**，以防止低流动性下的瞬间扫损。

#### 3.3 止盈 (Take Profit)
采用 **盈亏比 (Risk-Reward Ratio)** 设置主动止盈。
*   **风险值 (Risk)**: `| 入场价 - 止损价 |`
*   **止盈目标**: `入场价 +/- 2.0 * Risk`
*   **盈亏比**: 2:1 (每笔交易预期收益为风险的 2 倍)。

## 4. 多周期过滤 (Multi-Timeframe Filtering)

为减少小周期 (如 30分钟) 的假信号，引入大周期 (如 1天/4小时) 趋势过滤。

### 4.1 过滤逻辑
*   **大周期指标**: 使用大周期的 MACD 指标 (Diff)。
*   **趋势定义**:
    *   **多头趋势**: MACD Diff > 0
    *   **空头趋势**: MACD Diff < 0
*   **过滤规则**:
    *   **做多信号 (B)**: 仅在大周期为 **多头** 时允许执行。
    *   **做空信号 (S)**: 仅在大周期为 **空头** 时允许执行。
    *   **逆势信号**: 若信号方向与大周期趋势相反，则被过滤 (Filtered)。

## 5. 数据源与回测

*   **数据源**: 支持 TQ (天勤), TDX (通达信), DB (本地数据库)。
*   **回测模式**: 事件驱动回测 (Event-Driven Backtest)，模拟真实交易流。
*   **命令示例**:
    ```bash
    # 运行 30分钟 回测 (自动启用 1天 过滤)
    python main.py --event-backtest --symbol KQ.m@SHFE.rb --period 30m --source db
    
    # 运行 1天 回测 (无过滤)
    python main.py --event-backtest --symbol KQ.m@SHFE.rb --period 1d --source db
    ```
