<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChanQuant Pro | ç¼ è®ºé‡åŒ–äº¤æ˜“ç³»ç»Ÿ</title>
    <script src="/static/echarts.min.js"></script>
    <script src="/static/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Color Palette - Dark Pro Theme */
            --bg-body: #121212;
            --bg-card: #1e1e1e;
            --bg-hover: #2d2d2d;
            --bg-input: #2c2c2c;
            --border-color: #333;
            
            --text-primary: #e0e0e0;
            --text-secondary: #a0a0a0;
            --text-muted: #666;

            --primary: #2962ff;
            --primary-hover: #1e4bd8;
            --success: #00e676;
            --success-dark: #00b248;
            --danger: #ff1744;
            --danger-dark: #d50000;
            --warning: #ffc107;
            --info: #00b0ff;

            --font-main: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --font-mono: 'JetBrains Mono', 'Courier New', Courier, monospace;

            --sidebar-width: 240px;
            --header-height: 60px;
            --radius: 8px;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        * { box-sizing: border-box; }

        body {
            font-family: var(--font-main);
            background: var(--bg-body);
            color: var(--text-primary);
            margin: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
        }

        /* --- Layout --- */
        .app-sidebar {
            width: var(--sidebar-width);
            background: var(--bg-card);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            padding: 20px 0;
            z-index: 10;
        }

        .app-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: var(--bg-body);
        }

        .app-header {
            height: var(--header-height);
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
        }

        .app-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        /* --- Sidebar --- */
        .logo {
            padding: 0 24px 20px;
            font-size: 20px;
            font-weight: 700;
            color: var(--primary);
            letter-spacing: -0.5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .logo span { color: var(--text-primary); }

        .nav-menu {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .nav-item {
            padding: 12px 24px;
            cursor: pointer;
            color: var(--text-secondary);
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
            border-left: 3px solid transparent;
        }

        .nav-item:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: rgba(41, 98, 255, 0.1);
            color: var(--primary);
            border-left-color: var(--primary);
        }

        .status-box {
            margin-top: auto;
            padding: 20px 24px;
            font-size: 12px;
            color: var(--text-muted);
            border-top: 1px solid var(--border-color);
        }

        /* --- UI Components --- */
        .card {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .card-title {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .control-row {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
        }

        input, select {
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 4px;
            font-family: var(--font-main);
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
        }
        input:focus, select:focus { border-color: var(--primary); }

        button {
            background: var(--bg-hover);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            font-family: var(--font-main);
            font-size: 14px;
        }
        button:hover { background: #3d3d3d; border-color: #555; }
        
        button.primary { background: var(--primary); color: white; border: none; }
        button.primary:hover { background: var(--primary-hover); }
        
        button.success { background: var(--success-dark); color: white; border: none; }
        button.success:hover { background: var(--success); }
        
        button.danger { background: var(--danger-dark); color: white; border: none; }
        button.danger:hover { background: var(--danger); }

        /* --- Signal Chips --- */
        .signal-group {
            display: inline-flex;
            background: var(--bg-input);
            padding: 4px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }
        .signal-label {
            font-size: 12px; 
            color: var(--text-muted); 
            margin-right: 8px; 
            align-self: center;
            padding-left: 8px;
        }
        .signal-toggle {
            padding: 4px 10px;
            font-size: 12px;
            cursor: pointer;
            border-radius: 4px;
            color: var(--text-secondary);
            transition: all 0.2s;
            user-select: none;
            font-weight: 600;
        }
        .signal-toggle:hover { color: var(--text-primary); background: rgba(255,255,255,0.05); }
        .signal-toggle.active { color: white; }
        
        .signal-toggle.active[data-type*='B'] { background: var(--success-dark); }
        .signal-toggle.active[data-type*='S'] { background: var(--danger-dark); }

        /* --- Tables --- */
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th { text-align: left; padding: 12px; color: var(--text-secondary); border-bottom: 1px solid var(--border-color); font-weight: 500; }
        td { padding: 12px; border-bottom: 1px solid var(--bg-body); color: var(--text-primary); }
        tr:hover td { background: var(--bg-hover); }
        
        /* --- Terminal Log --- */
        .log-box {
            background: #000;
            color: #00e676;
            font-family: var(--font-mono);
            font-size: 12px;
            padding: 16px;
            border-radius: var(--radius);
            height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            line-height: 1.5;
        }
        .log-box::-webkit-scrollbar { width: 8px; }
        .log-box::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }

        /* --- Chart Area --- */
        #chart { width: 100%; height: 600px; border-radius: var(--radius); overflow: hidden; }

        /* --- Badges --- */
        .badge { padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; color: white; }
        .badge-1B { background: var(--success); color: black; }
        .badge-2B { background: var(--success-dark); }
        .badge-3B { background: #00b0ff; }
        .badge-1S { background: var(--danger); color: white; }
        .badge-2S { background: var(--danger-dark); }
        .badge-3S { background: var(--warning); color: black; }

        /* --- Helper Classes --- */
        .tab-content { display: none; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .flex-spacer { margin-left: auto; }
        .text-small { font-size: 12px; }
        .text-muted { color: var(--text-muted); }

        /* --- Documentation Styles --- */
        #docContent {
            color: var(--text-primary);
            line-height: 1.6;
            max-width: 800px;
        }
        #docContent h2 { border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-top: 30px; color: var(--primary); }
        #docContent h3 { margin-top: 25px; color: var(--text-primary); }
        #docContent h4 { margin-top: 20px; color: var(--text-secondary); }
        #docContent table { width: 100%; border-collapse: collapse; margin: 20px 0; background: var(--bg-card); border-radius: 8px; overflow: hidden; }
        #docContent th, #docContent td { border: 1px solid var(--border-color); padding: 12px; text-align: left; }
        #docContent th { background: rgba(255,255,255,0.05); color: var(--text-secondary); font-weight: 600; }
        #docContent tr:hover td { background: var(--bg-hover); }
        #docContent blockquote { border-left: 4px solid var(--primary); margin: 0; padding: 10px 20px; background: rgba(41, 98, 255, 0.1); color: var(--text-secondary); border-radius: 0 4px 4px 0; }
        #docContent code { font-family: var(--font-mono); background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 4px; font-size: 0.9em; color: var(--warning); }
        #docContent pre { background: #000; padding: 15px; border-radius: 8px; overflow-x: auto; border: 1px solid var(--border-color); }
        #docContent pre code { background: transparent; padding: 0; color: #a5d6ff; }
        #docContent ul, #docContent ol { padding-left: 20px; }
        #docContent li { margin-bottom: 6px; }
    </style>
</head>
<body>
    
    <!-- Sidebar -->
    <aside class="app-sidebar">
        <div class="logo">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
            </svg>
            <span>ChanQuant</span>
        </div>

        <ul class="nav-menu">
            <li class="nav-item active" onclick="switchTab('dashboard')">
                <span>ä»ªè¡¨ç›˜ Dashboard</span>
            </li>
            <li class="nav-item" onclick="switchTab('backtest')">
                <span>å›æµ‹ç³»ç»Ÿ Backtest</span>
            </li>
            <li class="nav-item" onclick="switchTab('config')">
                <span>é…ç½® Config</span>
            </li>
            <li class="nav-item" onclick="switchTab('docs')">
                <span>æ–‡æ¡£ Docs</span>
            </li>
            <li class="nav-item" onclick="switchTab('trades')">
                <span>ğŸ“‹</span> äº¤æ˜“è®°å½• Trade
            </li>
            <li class="nav-item" onclick="switchTab('system')">
                <span>ç³»ç»Ÿè¯Šæ–­ System</span>
            </li>
        </ul>

        <div class="status-box">
            <div id="status">System Ready</div>
            <div style="margin-top: 5px; opacity: 0.7;">v2.0.4 (TextMode)</div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="app-main">
        <header class="app-header">
            <h3 style="margin:0; font-weight:500;">äº¤æ˜“å·¥ä½œå°</h3>
            <div class="control-row">
                 <div class="signal-group" style="border:none; background:transparent;">
                    <input type="checkbox" id="autoUpdate" onchange="toggleAutoUpdate()" style="margin-right: 6px;">
                    <label for="autoUpdate" class="text-small" style="cursor: pointer; color: var(--text-secondary);">è‡ªåŠ¨æ›´æ–° (60s)</label>
                </div>
                <div style="border-left: 1px solid var(--border-color); height: 20px; margin: 0 10px;"></div>
                <input type="text" id="tqUser" placeholder="TQè´¦å·" style="width: 100px; background: transparent;">
                <input type="password" id="tqPass" placeholder="TQå¯†ç " style="width: 100px; background: transparent;">
            </div>
        </header>

        <div class="app-content">
            
            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content active">
                
                <!-- Chart Controls -->
                <div class="card">
                    <div class="control-row">
                        <!-- Symbol & Period -->
                        <div style="display:flex; gap:10px; align-items:center;">
                            <input type="text" id="symbol" value="KQ.m@SHFE.rb" placeholder="åˆçº¦ä»£ç " list="symbolList" style="width: 140px; font-weight:600;">
                            <datalist id="symbolList">
                                <option value="KQ.m@SHFE.rb">èºçº¹é’¢ (RB)</option>
                                <option value="KQ.m@CZCE.FG">ç»ç’ƒ (FG)</option>
                                <option value="KQ.m@CZCE.SA">çº¯ç¢± (SA)</option>
                                <option value="KQ.m@DCE.v">PVC (v)</option>
                            </datalist>
                            <select id="period" style="font-weight:600;">
                                <option value="1m">1åˆ†é’Ÿ</option>
                                <option value="5m">5åˆ†é’Ÿ</option>
                                <option value="30m" selected>30åˆ†é’Ÿ</option>
                                <option value="1d">æ—¥çº¿</option>
                            </select>
                            <select id="strategy" style="font-weight:600; width: 120px;">
                                <option value="standard" selected>æ ‡å‡†ç­–ç•¥</option>
                                <option value="pure_chan">çº¯ç¼ è®º</option>
                            </select>
                            <button class="primary" onclick="loadChart()">åŠ è½½å›¾è¡¨</button>
                        </div>

                        <div style="border-left: 1px solid var(--border-color); height: 24px;"></div>

                        <!-- Actions -->
                        <button onclick="runImport()">å¯¼å…¥æ•°æ®</button>
                        <button onclick="exportData()">å¯¼å‡ºCSV</button>
                        <button onclick="runSimpleBacktest()">Swingå›æµ‹</button>
                        
                        <div class="flex-spacer"></div>

                        <!-- Signal Toggles -->
                        <div class="signal-group" id="signal-toggles">
                            <span class="signal-label">æ˜¾ç¤ºä¿¡å·:</span>
                            <span class="signal-toggle active" data-type="1B" onclick="toggleSignal(this)">1B</span>
                            <span class="signal-toggle active" data-type="2B" onclick="toggleSignal(this)">2B</span>
                            <span class="signal-toggle active" data-type="3B" onclick="toggleSignal(this)">3B</span>
                            <span style="width: 1px; background: var(--border-color); height: 12px; margin: 0 6px; display:inline-block; vertical-align:middle;"></span>
                            <span class="signal-toggle active" data-type="1S" onclick="toggleSignal(this)">1S</span>
                            <span class="signal-toggle active" data-type="2S" onclick="toggleSignal(this)">2S</span>
                            <span class="signal-toggle active" data-type="3S" onclick="toggleSignal(this)">3S</span>
                        </div>
                    </div>
                </div>

                <!-- Main Chart -->
                <div class="card" style="padding: 0; border: none; background: transparent;">
                    <div id="chart"></div>
                </div>

                <div class="row" style="display: flex; gap: 20px;">
                    <!-- Latest Signals -->
                    <div class="card" style="flex: 2; display: flex; flex-direction: column; min-height: 300px;">
                        <div class="card-header">
                            <h4 class="card-title">æœ€æ–°ä¿¡å·ç›‘æ§ Latest Signals</h4>
                            <div class="control-row text-small">
                                <select id="sig_symbol" onchange="loadSignals(1)" style="padding: 4px 8px;">
                                    <option value="">æ‰€æœ‰åˆçº¦</option>
                                    <option value="KQ.m@SHFE.rb">èºçº¹é’¢</option>
                                    <option value="KQ.m@CZCE.FG">ç»ç’ƒ</option>
                                    <option value="KQ.m@CZCE.SA">çº¯ç¢±</option>
                                    <option value="KQ.m@DCE.v">PVC</option>
                                </select>
                                <select id="sig_period" onchange="loadSignals(1)" style="padding: 4px 8px;">
                                    <option value="">æ‰€æœ‰çº§åˆ«</option>
                                    <option value="1d">1d</option>
                                    <option value="30m">30m</option>
                                    <option value="5m">5m</option>
                                </select>
                                <button onclick="loadSignals(1)" style="padding: 4px 10px;">åˆ·æ–°</button>
                            </div>
                        </div>
                        
                        <!-- Signal Legend -->
                        <div style="margin-bottom: 10px; padding: 10px; background: rgba(255,255,255,0.03); border-radius: 4px; font-size: 12px; display: flex; gap: 15px; flex-wrap: wrap;">
                            <div style="display:flex; align-items:center; gap:5px;">
                                <span class="badge badge-1B">1B</span> <span style="color:#aaa;">è¶‹åŠ¿èƒŒé©° (Reversal) 10%</span>
                            </div>
                            <div style="display:flex; align-items:center; gap:5px;">
                                <span class="badge badge-2B">2B</span> <span style="color:#aaa;">å›è¸©ç¡®è®¤ (Confirm) 7%</span>
                            </div>
                            <div style="display:flex; align-items:center; gap:5px;">
                                <span class="badge badge-3B">3B</span> <span style="color:#aaa;">è¶‹åŠ¿è·Ÿéš (Follow) 5%</span>
                            </div>
                            <div style="border-left: 1px solid #444; margin: 0 5px;"></div>
                            <div style="display:flex; align-items:center; gap:5px;">
                                <span class="badge badge-1S">1S</span> <span style="color:#aaa;">è¶‹åŠ¿èƒŒé©° (Reversal) 10%</span>
                            </div>
                            <div style="display:flex; align-items:center; gap:5px;">
                                <span class="badge badge-2S">2S</span> <span style="color:#aaa;">å›è¸©ç¡®è®¤ (Confirm) 7%</span>
                            </div>
                            <div style="display:flex; align-items:center; gap:5px;">
                                <span class="badge badge-3S">3S</span> <span style="color:#aaa;">è¶‹åŠ¿è·Ÿéš (Follow) 5%</span>
                            </div>
                        </div>

                        <div style="flex: 1; overflow-y: auto;">
                            <table id="signalTable">
                                <thead>
                                    <tr>
                                        <th>æ—¶é—´</th>
                                        <th>åˆçº¦</th>
                                        <th>çº§åˆ«</th>
                                        <th>ç±»å‹</th>
                                        <th>ä»·æ ¼</th>
                                        <th>æ­¢æŸ/ä»“ä½</th>
                                        <th>æè¿°</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <div style="margin-top: 10px; display: flex; justify-content: center; gap: 10px;">
                             <button onclick="changeSignalPage(-1)" class="small">ä¸Šä¸€é¡µ</button>
                             <span id="pageInfo" style="align-self: center; font-size: 12px; color: var(--text-secondary);">Page 1</span>
                             <button onclick="changeSignalPage(1)" class="small">ä¸‹ä¸€é¡µ</button>
                        </div>
                    </div>

                    <!-- System Log -->
                    <div class="card" style="flex: 1; display: flex; flex-direction: column; min-height: 300px;">
                        <div class="card-header">
                            <h4 class="card-title">ç³»ç»Ÿæ—¥å¿—</h4>
                        </div>
                        <div id="logBox" class="log-box" style="flex: 1; height: auto;">
                            <div>[System] ChanQuant Pro Initialized...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Backtest Tab -->
            <div id="backtest" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title">äº‹ä»¶é©±åŠ¨å›æµ‹é…ç½®</h4>
                    </div>
                    <div class="control-row">
                        <div style="display:flex; flex-direction:column; gap:5px;">
                            <label class="text-small text-muted">åˆçº¦</label>
                            <input type="text" id="bt_symbol" value="KQ.m@SHFE.rb" list="symbolList">
                        </div>
                        <div style="display:flex; flex-direction:column; gap:5px;">
                            <label class="text-small text-muted">äº¤æ˜“å‘¨æœŸ</label>
                            <select id="bt_period">
                                <option value="30m">30åˆ†é’Ÿ</option>
                                <option value="5m">5åˆ†é’Ÿ</option>
                                <option value="1d">æ—¥çº¿</option>
                            </select>
                        </div>
                        <div style="display:flex; flex-direction:column; gap:5px;">
                            <label class="text-small text-muted">å›æµ‹å¤©æ•°</label>
                            <input type="number" id="bt_days" value="30" style="width: 80px;">
                        </div>
                        <div style="display:flex; flex-direction:column; gap:5px;">
                            <label class="text-small text-muted">è¶‹åŠ¿è¿‡æ»¤å‘¨æœŸ</label>
                            <select id="bt_filter">
                                <option value="">æ— </option>
                                <option value="1d" selected>1å¤© (1d)</option>
                                <option value="4h">4å°æ—¶ (4h)</option>
                            </select>
                        </div>
                        <div style="display:flex; flex-direction:column; gap:5px;">
                            <label class="text-small text-muted">ç­–ç•¥é€‰æ‹©</label>
                            <select id="bt_strategy">
                                <option value="standard" selected>æ ‡å‡†ç­–ç•¥</option>
                                <option value="pure_chan">çº¯ç¼ è®º</option>
                            </select>
                        </div>
                        <div style="display:flex; flex-direction:column; gap:5px; justify-content:flex-end;">
                            <button class="primary" onclick="runEventBacktest()" style="height: 38px;">å¼€å§‹å›æµ‹</button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title">å›æµ‹è¿è¡Œç»“æœ</h4>
                    </div>
                    <div id="bt_result" style="background: var(--bg-input); padding: 15px; border-radius: 4px; font-family: var(--font-mono); white-space: pre-wrap; color: var(--text-secondary);">ç­‰å¾…è¿è¡Œ...</div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title">å†å²å›æµ‹è®°å½• (Database)</h4>
                        <button onclick="loadBacktestHistory()">åˆ·æ–°åˆ—è¡¨</button>
                    </div>
                    <div style="overflow-x: auto;">
                        <table id="btHistoryTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>æ—¶é—´</th>
                                    <th>åˆçº¦</th>
                                    <th>å‘¨æœŸ</th>
                                    <th>æ”¶ç›Šç‡</th>
                                    <th>ç›ˆäº</th>
                                    <th>äº¤æ˜“æ•°</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Config Tab -->
            <div id="config" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title">èºçº¹é’¢ç­–ç•¥é…ç½® (Rebar Strategy Config)</h4>
                        <div class="control-row">
                            <button class="primary" onclick="saveRebarConfig()">ä¿å­˜é…ç½® Save</button>
                            <button onclick="loadRebarConfig()">é‡ç½® Reset</button>
                        </div>
                    </div>
                    <div style="margin-bottom: 10px; color: var(--text-muted); font-size: 12px;">
                        ä¿®æ”¹ strategy/rebar/params.jsonã€‚è¯·ç¡®ä¿ JSON æ ¼å¼æ­£ç¡®ã€‚
                    </div>
                    <textarea id="configEditor" style="width: 100%; height: 500px; background: #000; color: #a5d6ff; font-family: var(--font-mono); border: 1px solid var(--border-color); padding: 10px; border-radius: 4px; resize: vertical;"></textarea>
                </div>
            </div>

            <!-- Docs Tab -->
            <div id="docs" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title">ç­–ç•¥æ–‡æ¡£</h4>
                    </div>
                    <div id="docContent">Loading...</div>
                </div>
            </div>

            <!-- Trades Tab -->
            <div id="trades" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title">å®ç›˜äº¤æ˜“è®°å½• (Trade History)</h4>
                        <div class="control-row">
                             <select id="trade_filter_symbol" onchange="loadTradeRecords()">
                                <option value="">æ‰€æœ‰åˆçº¦</option>
                                <option value="KQ.m@SHFE.rb">èºçº¹é’¢</option>
                                <option value="KQ.m@CZCE.FG">ç»ç’ƒ</option>
                             </select>
                             <button onclick="loadTradeRecords()">åˆ·æ–°åˆ—è¡¨</button>
                        </div>
                    </div>
                    <div style="overflow-x: auto;">
                        <table id="tradeHistoryTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>åˆçº¦</th>
                                    <th>æ–¹å‘</th>
                                    <th>çŠ¶æ€</th>
                                    <th>å¼€ä»“æ—¶é—´</th>
                                    <th>å¼€ä»“ä»·</th>
                                    <th>å¹³ä»“æ—¶é—´</th>
                                    <th>å¹³ä»“ä»·</th>
                                    <th>ç›ˆäº (PnL)</th>
                                    <th>æ”¶ç›Šç‡</th>
                                    <th>åŸå› </th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- System Tab -->
            <div id="system" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title">ç³»ç»Ÿè¯Šæ–­ System Diagnostics</h4>
                        <div class="control-row" style="gap: 10px; flex-wrap: wrap;">
                            <button class="primary" onclick="runSystemTest('full')">è¿è¡Œå®Œæ•´æµ‹è¯• Full Test</button>
                            <button onclick="runSystemTest('signal_filter')">ä¿¡å·è¿‡æ»¤ Signal Filter</button>
                            <button onclick="runSystemTest('rebar')">èºçº¹é’¢ç­–ç•¥ Rebar Strategy</button>
                            <button onclick="runSystemTest('real_time')">å®æ—¶äº¤æ˜“ç³»ç»Ÿ Real-Time</button>
                        </div>
                    </div>
                    <div style="margin-top: 20px;">
                        <div id="testStatus" style="font-weight: bold; margin-bottom: 10px;"></div>
                        <div id="testReport" class="markdown-body" style="background: #111; padding: 20px; border-radius: 4px; border: 1px solid var(--border-color); font-family: monospace; white-space: pre-wrap;">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æµ‹è¯•...</div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title">å®æ—¶ç³»ç»Ÿæ§åˆ¶ Real-Time Control</h4>
                    </div>
                    <div class="control-row" style="gap: 10px; flex-wrap: wrap;">
                        <div style="display:flex; flex-direction:column; gap:5px;">
                            <label class="text-small text-muted">åˆçº¦</label>
                            <input type="text" id="rt_symbol" value="rb2505" style="width:140px;">
                        </div>
                        <div style="display:flex; flex-direction:column; gap:5px;">
                            <label class="text-small text-muted">æ•°æ®æº</label>
                            <select id="rt_source" style="width:120px;">
                                <option value="tdx" selected>TDX</option>
                                <option value="tq">TQSDK</option>
                                <option value="db">DB</option>
                            </select>
                        </div>
                        <div style="display:flex; flex-direction:column; gap:5px; min-width:260px;">
                            <label class="text-small text-muted">ä¼ä¸šå¾®ä¿¡Webhook</label>
                            <input type="text" id="rt_webhook" placeholder="https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=..." style="min-width:260px;">
                        </div>
                        <div style="display:flex; align-items:flex-end; gap:10px;">
                            <button class="primary" onclick="startRealtime()">å¯åŠ¨ Start</button>
                            <button onclick="stopRealtime()">åœæ­¢ Stop</button>
                        </div>
                        <div style="display:flex; flex-direction:column; gap:5px;">
                            <label class="text-small text-muted">çŠ¶æ€</label>
                            <div id="rt_status" class="text-small text-muted">Unknown</div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <script>
        // --- Global State ---
        let currentSignalPage = 1;
        const signalLimit = 20;
        let chartInstance = null;
        let backtestHistoryCache = {};

        // --- Initialization ---
        window.onload = function() {
            // Init ECharts with Dark Theme
            chartInstance = echarts.init(document.getElementById('chart'), 'dark', {
                renderer: 'canvas',
                useDirtyRect: false
            });
            // Overwrite background to match transparent/card
            chartInstance.setOption({ backgroundColor: 'transparent' });

            window.addEventListener('resize', () => chartInstance.resize());
            
            loadSignals(1);
            loadDocs();
            loadBacktestHistory();
            loadChart(); // Auto load chart on start
            loadRealtimeStatus();
        };

        // --- Tabs ---
        function switchTab(tabId) {
            document.querySelectorAll('.nav-item').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            // Find nav item by text content roughly or index, here using onclick match for simplicity
            const navItem = Array.from(document.querySelectorAll('.nav-item')).find(el => el.getAttribute('onclick').includes(tabId));
            if(navItem) navItem.classList.add('active');

            document.getElementById(tabId).classList.add('active');
            
            if (tabId === 'dashboard') {
                setTimeout(() => chartInstance.resize(), 100);
            }
            if (tabId === 'config') {
                loadRebarConfig();
            }
            if (tabId === 'docs') {
                loadDocs();
            }
            if (tabId === 'trades') {
                loadTradeRecords();
            }
        }

        async function loadRebarConfig() {
            try {
                const res = await fetch('/api/config/rebar');
                const data = await res.json();
                if (data.error) {
                    document.getElementById('configEditor').value = "Error: " + data.error;
                } else {
                    document.getElementById('configEditor').value = JSON.stringify(data, null, 4);
                }
            } catch (e) {
                document.getElementById('configEditor').value = "Error loading config: " + e.message;
            }
        }

        async function saveRebarConfig() {
            const content = document.getElementById('configEditor').value;
            try {
                // Validate JSON locally first
                const json = JSON.parse(content);
                
                const res = await fetch('/api/config/rebar', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(json)
                });
                const data = await res.json();
                
                if (data.status === 'success') {
                    alert('é…ç½®ä¿å­˜æˆåŠŸ Config Saved!');
                    log('Rebar config updated.');
                } else {
                    alert('ä¿å­˜å¤±è´¥ Error: ' + data.error);
                }
            } catch (e) {
                alert('æ— æ•ˆçš„ JSON æ ¼å¼ Invalid JSON: ' + e.message);
            }
        }

        async function loadDocs(filename = 'index.md') {
            const docContent = document.getElementById('docContent');
            if (!docContent) return;

            try {
                // Load the specified doc file
                const res = await fetch(`/api/docs/file/${filename}`, { headers: { 'Cache-Control': 'no-cache' } });
                const text = await res.text();
                
                if (text && text.length > 0) {
                    // Check if marked is available
                    if (typeof marked !== 'undefined') {
                        try {
                            docContent.innerHTML = marked.parse(text);
                            // Intercept links
                            docContent.querySelectorAll('a').forEach(link => {
                                const href = link.getAttribute('href');
                                if (href && href.endsWith('.md')) {
                                    link.onclick = (e) => {
                                        e.preventDefault();
                                        loadDocs(href);
                                    };
                                }
                            });
                        } catch (parseErr) {
                            console.error("Marked Parse Error:", parseErr);
                            docContent.innerHTML = '<div class="alert error">Markdown Parsing Error</div><pre>' + text + '</pre>';
                        }
                    } else {
                        // Retry after 100ms if library is still loading
                        setTimeout(() => {
                            if (typeof marked !== 'undefined') {
                                docContent.innerHTML = marked.parse(text);
                            } else {
                                docContent.innerHTML = '<div class="alert warning">Markdown library missing. Showing raw text.</div><pre style="white-space: pre-wrap; font-family: monospace;">' + text + '</pre>';
                            }
                        }, 500);
                    }
                } else {
                    docContent.innerHTML = "æš‚æ— æ–‡æ¡£å†…å®¹";
                }
            } catch (e) {
                console.error("LoadDocs Error:", e);
                docContent.innerHTML = `<div style="color:var(--danger)">åŠ è½½æ–‡æ¡£å¤±è´¥: ${e.message}</div>`;
            }
        }

        // --- Logger ---
        function log(msg) {
            const box = document.getElementById('logBox');
            const time = new Date().toLocaleTimeString();
            box.innerHTML += `<div style="margin-bottom:4px;"><span style="color:var(--text-muted)">[${time}]</span> ${msg}</div>`;
            box.scrollTop = box.scrollHeight;
        }

        // --- Signal Toggles ---
        function toggleSignal(el) {
            el.classList.toggle('active');
            loadChart();
        }

        // --- Main Chart Logic ---
        async function loadChart() {
            const symbol = document.getElementById('symbol').value;
            const period = document.getElementById('period').value;
            const strategy = document.getElementById('strategy').value;
            
            log(`Loading chart for ${symbol} (${period}) using ${strategy}...`);
            
            // Ensure container exists
            const chartDom = document.getElementById('chart');
            if (!chartDom) {
                console.error("Chart DOM not found");
                return;
            }

            // Show loading on existing instance if possible, or just log
            if (chartInstance) {
                try {
                    chartInstance.showLoading({ color: '#2962ff', maskColor: 'rgba(30, 30, 30, 0.6)' });
                } catch(e) { 
                    // Ignore if instance is bad
                }
            }
            
            try {
                // 1. Get Bars
                const barsRes = await fetch(`/api/bars/${symbol}/${period}?limit=1000`);
                const barsData = await barsRes.json();
                
                if (!barsData || !Array.isArray(barsData) || barsData.length === 0) {
                    log('No data found. Please import data first.');
                    if (chartInstance) chartInstance.hideLoading();
                    return;
                }

                // 2. Get Analysis
                const analysisRes = await fetch(`/api/analysis/${symbol}/${period}?limit=1000&strategy_name=${strategy}`);
                const analysisData = await analysisRes.json();
                
                if (analysisData.error) {
                    log(`Analysis Error: ${analysisData.error}`);
                }

                const centers = analysisData.centers || [];
                const bi_list = analysisData.bi_list || [];
                const seg_list = analysisData.seg_list || [];
                const signals = analysisData.signals || [];

                // Data Processing
                const dates = barsData.map(item => item.dt);
                const kData = barsData.map(item => [item.open, item.close, item.low, item.high]);
                
                // Validate Data
                if (dates.some(d => d === undefined || d === null)) {
                    console.error("Found undefined dates");
                }
                
                // Signal MarkPoints
                const signalMarkPoints = [];
                
                // Get active signal types
                const activeTypes = new Set(
                    Array.from(document.querySelectorAll('.signal-toggle.active'))
                         .map(el => el.getAttribute('data-type'))
                );

                if (Array.isArray(signals)) {
                    signals.forEach(s => {
                        // Filter based on toggle
                        if (!activeTypes.has(s.type)) return;

                        const isBuy = s.type.includes('B');
                        // Color mapping for 1B/2B/3B
                        let color = isBuy ? '#00e676' : '#ff1744';
                        if (s.type === '1B') color = '#00e676'; // Bright Green
                        if (s.type === '2B') color = '#00b248'; // Medium Green
                        if (s.type === '3B') color = '#66bb6a'; // Light Green
                        if (s.type === '1S') color = '#ff1744'; // Bright Red
                        if (s.type === '2S') color = '#d50000'; // Deep Red
                        if (s.type === '3S') color = '#ef5350'; // Light Red

                        signalMarkPoints.push({
                            name: s.type,
                            coord: [s.dt, s.price],
                            value: s.type,
                            itemStyle: { color: color },
                            label: { show: true, fontSize: 10 },
                            tooltip: {
                                formatter: function(p) {
                                    let html = `<b>${s.type}</b><br/>Price: ${s.price}<br/>`;
                                    if(s.sl) html += `SL: ${s.sl.toFixed(1)}<br/>`;
                                    if(s.pos) {
                                        html += `Pos: ${(s.pos.ratio*100).toFixed(0)}%<br/>${s.pos.msg || ''}`;
                                    }
                                    return html;
                                }
                            }
                        });
                    });
                }
                
                // Indicators
                function calcEMA(data, n) {
                    let ema = [data[0]];
                    let k = 2 / (n + 1);
                    for (let i = 1; i < data.length; i++) {
                        ema.push(data[i] * k + ema[i-1] * (1 - k));
                    }
                    return ema;
                }
                const closes = barsData.map(i => i.close);
                const ema12 = calcEMA(closes, 12);
                const ema26 = calcEMA(closes, 26);
                const diff = ema12.map((v, i) => v - ema26[i]);
                const dea = calcEMA(diff, 9);
                const macd = diff.map((v, i) => (v - dea[i]) * 2);

                // Strategy Specific Indicators
                let ema5 = [], ema13 = [];
                if (strategy === 'pure_chan') {
                    ema5 = calcEMA(closes, 5);
                    ema13 = calcEMA(closes, 13);
                }

                // Prepare MarkAreas (ZhongShu)
                const markAreas = [];
                if (Array.isArray(centers)) {
                    centers.forEach(c => {
                        if (c && c.start_dt && c.end_dt && c.zg !== undefined && c.zd !== undefined) {
                            markAreas.push([
                                {
                                    xAxis: c.start_dt,
                                    yAxis: c.zg,
                                    itemStyle: { color: 'rgba(255, 193, 7, 0.1)', borderWidth: 1, borderColor: '#ffc107', borderType: 'dashed' }
                                },
                                {
                                    xAxis: c.end_dt,
                                    yAxis: c.zd
                                }
                            ]);
                        }
                    });
                }

                // Construct Option
                const option = {
                    backgroundColor: 'transparent',
                    animation: false,
                    title: { text: `${symbol} - ${period}`, textStyle: { color: '#e0e0e0' } },
                    tooltip: { 
                        trigger: 'axis', 
                        axisPointer: { type: 'cross' },
                        backgroundColor: 'rgba(30,30,30,0.9)',
                        borderColor: '#333',
                        textStyle: { color: '#e0e0e0' }
                    },
                    legend: { data: ['K-Line', 'EMA5', 'EMA13', 'MACD', 'DIFF', 'DEA', 'Bi', 'Seg'], textStyle: { color: '#a0a0a0' } },
                    grid: [
                        { left: '3%', right: '3%', top: '10%', height: '60%' },
                        { left: '3%', right: '3%', top: '75%', height: '20%' }
                    ],
                    xAxis: [
                        { type: 'category', data: dates, scale: true, boundaryGap: false, axisLine: { lineStyle: { color: '#333' } }, gridIndex: 0 },
                        { type: 'category', gridIndex: 1, data: dates, show: false }
                    ],
                    yAxis: [
                        { type: 'value', scale: true, splitLine: { lineStyle: { color: '#333' } }, gridIndex: 0 },
                        { type: 'value', scale: true, gridIndex: 1, splitNumber: 2, splitLine: { lineStyle: { color: '#333' } } }
                    ],
                    dataZoom: [
                        { type: 'inside', xAxisIndex: [0, 1], start: 80, end: 100 },
                        { show: true, xAxisIndex: [0, 1], type: 'slider', top: '96%', start: 80, end: 100, borderColor: '#333', fillerColor: 'rgba(41, 98, 255, 0.2)' }
                    ],
                    series: [
                        {
                            name: 'K-Line',
                            type: 'candlestick',
                            data: kData,
                            xAxisIndex: 0,
                            yAxisIndex: 0,
                            itemStyle: {
                                color: '#ff1744',
                                color0: '#00e676',
                                borderColor: '#ff1744',
                                borderColor0: '#00e676'
                            },
                            markArea: {
                                data: markAreas,
                                label: { show: true, position: 'top', color: '#ffc107', formatter: 'ZS' }
                            },
                            markPoint: {
                                data: signalMarkPoints,
                                symbol: 'pin',
                                symbolSize: 40,
                                label: { color: '#fff' }
                            }
                        },
                        {
                            name: 'EMA5',
                            type: 'line',
                            data: strategy === 'pure_chan' ? ema5 : [],
                            smooth: true,
                            showSymbol: false,
                            lineStyle: { width: 1, color: '#e0e0e0' } // White
                        },
                        {
                            name: 'EMA13',
                            type: 'line',
                            data: strategy === 'pure_chan' ? ema13 : [],
                            smooth: true,
                            showSymbol: false,
                            lineStyle: { width: 1, color: '#ffc107' } // Yellow
                        },
                        {
                            name: 'MACD',
                            type: 'bar',
                            xAxisIndex: 1,
                            yAxisIndex: 1,
                            data: macd,
                            itemStyle: {
                                color: (params) => params.value > 0 ? '#ff1744' : '#00e676'
                            }
                        },
                        {
                            name: 'DIFF',
                            type: 'line',
                            xAxisIndex: 1,
                            yAxisIndex: 1,
                            data: diff,
                            showSymbol: false,
                            lineStyle: { width: 1, color: '#e0e0e0' } // White
                        },
                        {
                            name: 'DEA',
                            type: 'line',
                            xAxisIndex: 1,
                            yAxisIndex: 1,
                            data: dea,
                            showSymbol: false,
                            lineStyle: { width: 1, color: '#ffc107' } // Yellow
                        },
                        {
                            name: 'Bi',
                            type: 'line',
                            data: [], 
                            xAxisIndex: 0,
                            yAxisIndex: 0,
                            showSymbol: false,
                            lineStyle: { color: '#00b0ff', width: 1, type: 'dashed' }
                        }
                    ]
                };

                // RE-INIT CHART to avoid internal state errors
                if (chartInstance) {
                    chartInstance.dispose();
                }
                chartInstance = echarts.init(chartDom, 'dark', {
                    renderer: 'canvas',
                    useDirtyRect: false
                });
                // Background override
                chartInstance.setOption({ backgroundColor: 'transparent' });

                console.log('Setting Option:', option);
                chartInstance.setOption(option);
                chartInstance.hideLoading();

            } catch (e) {
                console.error("LoadChart Error:", e);
                log('Error loading chart: ' + e.message);
                if (chartInstance) chartInstance.hideLoading();
            }
        }

        // --- Other Functions (Signals, Import, Export, Backtest) ---
        // Kept mostly same logic but ensure ID references match new HTML

        async function loadSignals(page) {
            currentSignalPage = page;
            const symbolFilter = document.getElementById('sig_symbol').value;
            const periodFilter = document.getElementById('sig_period').value;
            
            let url = `/api/signals?page=${page}&limit=${signalLimit}`;
            if (symbolFilter) url += `&symbol=${symbolFilter}`;
            if (periodFilter) url += `&period=${periodFilter}`;
            
            try {
                const res = await fetch(url);
                const data = await res.json();
                
                const tbody = document.querySelector('#signalTable tbody');
                tbody.innerHTML = '';
                
                data.data.forEach(s => {
                    // Position Management Info
                    let posInfo = "";
                    let slInfo = "";
                    
                    // Fallback: Try to parse Pos from description if s.pos is missing
                    if (!s.pos && s.description) {
                        const match = s.description.match(/\[Pos:(\d+)%\]/);
                        if (match) {
                            s.pos = { ratio: parseInt(match[1]) / 100 };
                        }
                    }

                    // Fallback: Try to parse SL from description if s.sl is missing
                    if (!s.sl && s.description) {
                        const match = s.description.match(/\[SL:([\d\.]+)\]/);
                        if (match) {
                            s.sl = parseFloat(match[1]);
                        }
                    }

                    if (s.pos) {
                        posInfo = `<div class="badge" style="background: #666; font-size: 10px; margin-top: 2px;">Pos: ${(s.pos.ratio * 100).toFixed(0)}%</div>`;
                    }
                    if (s.sl) {
                        slInfo = `<div style="font-size: 11px; color: #ff1744;">SL: ${s.sl.toFixed(1)}</div>`;
                    }

                    const row = `<tr>
                        <td style="color:var(--text-secondary)">${s.dt}</td>
                        <td style="font-weight:500">${s.symbol}</td>
                        <td>${s.period}</td>
                        <td><span class="badge badge-${s.signal_type}">${s.signal_type}</span></td>
                        <td style="font-family:var(--font-mono)">${s.price.toFixed(2)}</td>
                        <td>${slInfo}${posInfo}</td>
                        <td class="text-muted text-small">${s.description || '-'}</td>
                    </tr>`;
                    tbody.innerHTML += row;
                });
                
                document.getElementById('pageInfo').innerText = `Page ${data.page} / ${Math.ceil(data.total / data.limit)}`;
            } catch (e) {
                log('Error loading signals: ' + e.message);
            }
        }

        function changeSignalPage(delta) {
            const newPage = currentSignalPage + delta;
            if (newPage < 1) return;
            loadSignals(newPage);
        }

        function toggleAutoUpdate() {
            const cb = document.getElementById('autoUpdate');
            if (cb.checked) {
                log('Auto update enabled (60s)');
                window.autoTimer = setInterval(() => {
                    loadChart();
                    loadSignals(1);
                }, 60000);
            } else {
                log('Auto update disabled');
                clearInterval(window.autoTimer);
            }
        }

        async function loadRealtimeStatus() {
            try {
                const res = await fetch('/api/realtime/status');
                const data = await res.json();
                const el = document.getElementById('rt_status');
                if (data.running) {
                    el.innerText = `è¿è¡Œä¸­ | ${data.symbol} (${data.period}) | ${data.data_source} | æ¯${Math.round(data.update_interval/60)}åˆ†é’Ÿ`;
                } else {
                    el.innerText = 'æœªè¿è¡Œ';
                }
            } catch (e) {
                console.error(e);
                const el = document.getElementById('rt_status');
                if (el) el.innerText = 'çŠ¶æ€è·å–å¤±è´¥';
            }
        }
        async function startRealtime() {
            const symbol = document.getElementById('rt_symbol').value;
            const source = document.getElementById('rt_source').value;
            const webhook = document.getElementById('rt_webhook').value;
            log(`Starting Real-Time System for ${symbol} via ${source}...`);
            try {
                const res = await fetch('/api/realtime/start', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ symbol: symbol, data_source: source, webhook_url: webhook })
                });
                const data = await res.json();
                if (data.status === 'started' || data.status === 'already_running') {
                    log(`Real-Time: ${data.status}`);
                } else {
                    log(`Real-Time Error: ${data.error || data.status}`);
                }
                loadRealtimeStatus();
            } catch (e) {
                log('Start Error: ' + e.message);
            }
        }
        async function stopRealtime() {
            log('Stopping Real-Time System...');
            try {
                const res = await fetch('/api/realtime/stop', { method: 'POST' });
                const data = await res.json();
                log(`Real-Time: ${data.status}`);
                loadRealtimeStatus();
            } catch (e) {
                log('Stop Error: ' + e.message);
            }
        }
        async function runSystemTest(type = 'full') {
            const statusEl = document.getElementById('testStatus');
            const reportEl = document.getElementById('testReport');
            
            const titles = {
                'full': 'System Diagnostics',
                'signal_filter': 'Signal Filter Tests',
                'rebar': 'Rebar Strategy Tests',
                'real_time': 'Real-Time System Tests'
            };
            
            statusEl.innerText = `Running ${titles[type]}... Please wait...`;
            statusEl.style.color = "var(--warning)";
            reportEl.innerHTML = "Loading...";
            
            try {
                const res = await fetch(`/api/test/run?type=${type}`);
                const data = await res.json();
                
                if (data.status === 'PASS' || data.status === 'success') {
                     statusEl.innerText = "TEST PASSED";
                     statusEl.style.color = "var(--success)";
                } else {
                     statusEl.innerText = "TEST FAILED/ERROR";
                     statusEl.style.color = "var(--danger)";
                }
                
                // Render Markdown
                if (typeof marked !== 'undefined') {
                    reportEl.innerHTML = marked.parse(data.report || "No report generated.");
                } else {
                    reportEl.innerText = data.report;
                }
                
            } catch (e) {
                statusEl.innerText = "NETWORK ERROR";
                statusEl.style.color = "var(--danger)";
                reportEl.innerText = "Error running tests: " + e.message;
            }
        }

        async function runImport() {
            const symbol = document.getElementById('symbol').value;
            const period = document.getElementById('period').value;
            const tqUser = document.getElementById('tqUser').value;
            const tqPass = document.getElementById('tqPass').value;
            
            // Trae preview does not support prompt(), use custom logic or default
            let days = "365";
            if (typeof prompt === "function") {
                try {
                   days = prompt(`è¯·è¾“å…¥å¯¼å…¥å¤©æ•° (é»˜è®¤ 365 å¤©):`, "365");
                } catch(e) {
                   console.warn("prompt() not supported, using default 365");
                }
            }
            if (days === null) return;

            log(`Starting Import for ${symbol} (${period})...`);
            
            try {
                const res = await fetch('/api/action/import', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        symbol: symbol, 
                        period: period,
                        days: parseInt(days) || 365,
                        tq_user: tqUser,
                        tq_pass: tqPass
                    })
                });
                const data = await res.json();
                log(`Import: ${data.message}`);
                alert(data.message);
            } catch (e) {
                log('Import Error: ' + e);
            }
        }

        function exportData() {
            const symbol = document.getElementById('symbol').value;
            const period = document.getElementById('period').value;
            const days = 365;
            if (!confirm(`ç¡®è®¤å¯¼å‡º ${symbol} (${period}) è¿‡å» ${days} å¤©çš„æ•°æ®ä¸ºCSV?`)) return;
            log(`Starting export for ${symbol}...`);
            window.open(`/api/export/bars/${symbol}/${period}?days=${days}`, '_blank');
        }

        async function runSimpleBacktest() {
            const symbol = document.getElementById('symbol').value;
            const period = document.getElementById('period').value;
            log(`Starting Swing Backtest for ${symbol}...`);
            try {
                const res = await fetch('/api/action/simple_backtest', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        symbol: symbol, 
                        period: period,
                        days: 365
                    })
                });
                const data = await res.json();
                if (data.status === 'success') {
                    const m = data.result.metrics;
                    const msg = `Return: ${(m.cum_return*100).toFixed(2)}%, WinRate: ${(m.win_rate*100).toFixed(2)}%, MaxDD: ${(m.max_drawdown*100).toFixed(2)}%`;
                    log('Backtest Done: ' + msg);
                    alert(`å›æµ‹å®Œæˆï¼\n${msg}`);
                } else {
                    log(`Backtest Failed: ${data.message}`);
                }
            } catch (e) {
                log('Backtest Error: ' + e);
            }
        }

        // --- Event Backtest & Docs (Preserved Logic) ---
        async function runEventBacktest() {
            const symbol = document.getElementById('bt_symbol').value;
            const period = document.getElementById('bt_period').value;
            const days = document.getElementById('bt_days').value;
            const filter = document.getElementById('bt_filter').value;
            const strategy = document.getElementById('bt_strategy').value;
            
            document.getElementById('bt_result').innerText = `Running backtest (${strategy})... please wait.`;
            
            try {
                const res = await fetch('/api/action/backtest', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        symbol: symbol, 
                        period: period, 
                        days: parseInt(days), 
                        filter_period: filter,
                        strategy_name: strategy
                    })
                });
                const data = await res.json();
                document.getElementById('bt_result').innerText = JSON.stringify(data, null, 2);
                loadBacktestHistory();
            } catch (e) {
                document.getElementById('bt_result').innerText = "Error: " + e;
            }
        }

        async function loadBacktestHistory() {
            try {
                const res = await fetch('/api/backtests');
                if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                const data = await res.json();
                
                if (!Array.isArray(data)) {
                    console.error("Backtest history data is not an array:", data);
                    return;
                }

                const tbody = document.querySelector('#btHistoryTable tbody');
                tbody.innerHTML = '';
                
                // Clear old cache
                backtestHistoryCache = {};

                data.forEach(item => {
                    // Store in cache
                    backtestHistoryCache[item.id] = item;

                    const row = `<tr>
                        <td>${item.id}</td>
                        <td>${new Date(item.created_at).toLocaleString()}</td>
                        <td>${item.symbol}</td>
                        <td>${item.period}</td>
                        <td style="color:${item.roi >= 0 ? 'var(--success)' : 'var(--danger)'}">
                            ${(item.roi * 100).toFixed(2)}%
                        </td>
                        <td>${item.pnl.toFixed(2)}</td>
                        <td>${item.total_trades}</td>
                        <td><button class="small" onclick="showBacktestDetails('${item.id}')">è¯¦æƒ…</button></td>
                    </tr>`;
                    tbody.innerHTML += row;
                });
            } catch (e) {
                console.error("Load history error:", e);
            }
        }

        function showBacktestDetails(id) {
            const item = backtestHistoryCache[id];
            if (!item) return;
            document.getElementById('bt_result').innerText = JSON.stringify(item, null, 2);
            switchTab('backtest'); // Ensure we are on the tab
        }

        async function loadTradeRecords() {
            const symbol = document.getElementById('trade_filter_symbol').value;
            let url = '/api/trades?limit=100';
            if (symbol) url += `&symbol=${symbol}`;
            
            try {
                const res = await fetch(url);
                const result = await res.json();
                const trades = result.data;
                
                const tbody = document.querySelector('#tradeHistoryTable tbody');
                tbody.innerHTML = '';
                
                if (!trades || trades.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="11" style="text-align:center; color:var(--text-muted)">æš‚æ— äº¤æ˜“è®°å½•</td></tr>';
                    return;
                }
                
                trades.forEach(t => {
                    const pnlClass = (t.pnl > 0) ? 'var(--success)' : (t.pnl < 0 ? 'var(--danger)' : '');
                    const pnlText = t.pnl !== null ? t.pnl.toFixed(2) : '-';
                    const roiText = t.roi !== null ? (t.roi * 100).toFixed(2) + '%' : '-';
                    
                    const row = `<tr>
                        <td>${t.id}</td>
                        <td>${t.symbol}</td>
                        <td><span class="badge ${t.direction === 'BUY' ? 'badge-1B' : 'badge-1S'}">${t.direction}</span></td>
                        <td>${t.status}</td>
                        <td>${new Date(t.entry_time).toLocaleString()}</td>
                        <td>${t.entry_price.toFixed(2)}</td>
                        <td>${t.exit_time ? new Date(t.exit_time).toLocaleString() : '-'}</td>
                        <td>${t.exit_price ? t.exit_price.toFixed(2) : '-'}</td>
                        <td style="color:${pnlClass}">${pnlText}</td>
                        <td style="color:${pnlClass}">${roiText}</td>
                        <td>${t.exit_reason || '-'}</td>
                    </tr>`;
                    tbody.innerHTML += row;
                });
            } catch (e) {
                console.error("Load trades error:", e);
                log("Error loading trades: " + e.message);
            }
        }
    </script>
</body>
</html>
